"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.match = match;
exports.serveFavicon = serveFavicon;
exports.setSecurityWebHeaders = setSecurityWebHeaders;
exports.validateName = validateName;
exports.validatePackage = validatePackage;
exports.media = media;
exports.encodeScopePackage = encodeScopePackage;
exports.expectJson = expectJson;
exports.antiLoop = antiLoop;
exports.allow = allow;
exports.final = final;
exports.log = log;
exports.errorReportingMiddleware = errorReportingMiddleware;
exports.LOG_VERDACCIO_BYTES = exports.LOG_VERDACCIO_ERROR = exports.LOG_STATUS_MESSAGE = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash"));

var _debug = _interopRequireDefault(require("debug"));

var _validator = _interopRequireDefault(require("validator"));

var _utils = require("../lib/utils");

var _constants = require("../lib/constants");

var _cryptoUtils = require("../lib/crypto-utils");

var _logger = require("../lib/logger");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const debug = (0, _debug.default)('verdaccio');

function match(regexp) {
  return function (req, res, next, value) {
    if (regexp.exec(value)) {
      next();
    } else {
      next('route');
    }
  };
}

function serveFavicon(config) {
  return function (req, res, next) {
    try {
      var _config$web;

      // @ts-ignore
      const logoConf = config === null || config === void 0 ? void 0 : (_config$web = config.web) === null || _config$web === void 0 ? void 0 : _config$web.favicon;

      if (logoConf === '') {
        debug('favicon disabled');
        res.status(404);
      } else if (!_lodash.default.isEmpty(logoConf)) {
        debug('custom favicon');

        if (_validator.default.isURL(logoConf, {
          require_host: true,
          require_valid_protocol: true
        })) {
          debug('redirect to %o', logoConf);
          res.redirect(logoConf);
          return;
        } else {
          const faviconPath = _path.default.normalize(logoConf);

          debug('serving favicon from %o', faviconPath);

          _fs.default.access(faviconPath, _fs.default.constants.R_OK, err => {
            if (err) {
              debug('no read permissions to read: %o, reason:', logoConf, err === null || err === void 0 ? void 0 : err.message);
              return res.status(_constants.HTTP_STATUS.NOT_FOUND).end();
            } else {
              res.setHeader('content-type', 'image/x-icon');

              _fs.default.createReadStream(faviconPath).pipe(res);

              debug('rendered custom ico');
            }
          });
        }
      } else {
        res.setHeader('content-type', 'image/x-icon');

        _fs.default.createReadStream(_path.default.posix.join(__dirname, './web/html/favicon.ico')).pipe(res);

        debug('rendered ico');
      }
    } catch (err) {
      debug('error triggered, favicon not found');
      res.status(_constants.HTTP_STATUS.NOT_FOUND).end();
    }
  };
}

function setSecurityWebHeaders(req, res, next) {
  // disable loading in frames (clickjacking, etc.)
  res.header(_constants.HEADERS.FRAMES_OPTIONS, 'deny'); // avoid stablish connections outside of domain

  res.header(_constants.HEADERS.CSP, "connect-src 'self'"); // https://stackoverflow.com/questions/18337630/what-is-x-content-type-options-nosniff

  res.header(_constants.HEADERS.CTO, 'nosniff'); // https://stackoverflow.com/questions/9090577/what-is-the-http-header-x-xss-protection

  res.header(_constants.HEADERS.XSS, '1; mode=block');
  next();
} // flow: express does not match properly
// flow info https://github.com/flowtype/flow-typed/issues?utf8=%E2%9C%93&q=is%3Aissue+is%3Aopen+express


function validateName(req, res, next, value, name) {
  if (value === '-') {
    // special case in couchdb usually
    next('route');
  } else if ((0, _utils.validateName)(value)) {
    next();
  } else {
    next(_utils.ErrorCode.getForbidden('invalid ' + name));
  }
} // flow: express does not match properly
// flow info https://github.com/flowtype/flow-typed/issues?utf8=%E2%9C%93&q=is%3Aissue+is%3Aopen+express


function validatePackage(req, res, next, value, name) {
  if (value === '-') {
    // special case in couchdb usually
    next('route');
  } else if ((0, _utils.validatePackage)(value)) {
    next();
  } else {
    next(_utils.ErrorCode.getForbidden('invalid ' + name));
  }
}

function media(expect) {
  return function (req, res, next) {
    if (req.headers[_constants.HEADER_TYPE.CONTENT_TYPE] !== expect) {
      next(_utils.ErrorCode.getCode(_constants.HTTP_STATUS.UNSUPPORTED_MEDIA, 'wrong content-type, expect: ' + expect + ', got: ' + req.get(_constants.HEADER_TYPE.CONTENT_TYPE)));
    } else {
      next();
    }
  };
}

function encodeScopePackage(req, res, next) {
  if (req.url.indexOf('@') !== -1) {
    // e.g.: /@org/pkg/1.2.3 -> /@org%2Fpkg/1.2.3, /@org%2Fpkg/1.2.3 -> /@org%2Fpkg/1.2.3
    req.url = req.url.replace(/^(\/@[^\/%]+)\/(?!$)/, '$1%2F');
  }

  next();
}

function expectJson(req, res, next) {
  if (!(0, _utils.isObject)(req.body)) {
    return next(_utils.ErrorCode.getBadRequest("can't parse incoming json"));
  }

  next();
}

function antiLoop(config) {
  return function (req, res, next) {
    var _req$headers;

    if ((req === null || req === void 0 ? void 0 : (_req$headers = req.headers) === null || _req$headers === void 0 ? void 0 : _req$headers.via) != null) {
      const arr = req.headers.via.split(',');

      for (let i = 0; i < arr.length; i++) {
        const m = arr[i].match(/\s*(\S+)\s+(\S+)/);

        if (m && m[2] === config.server_id) {
          return next(_utils.ErrorCode.getCode(_constants.HTTP_STATUS.LOOP_DETECTED, 'loop detected'));
        }
      }
    }

    next();
  };
}

function allow(auth) {
  return function (action) {
    return function (req, res, next) {
      req.pause();
      const packageName = req.params.scope ? `@${req.params.scope}/${req.params.package}` : req.params.package;
      const packageVersion = req.params.filename ? (0, _utils.getVersionFromTarball)(req.params.filename) : undefined;
      const remote = req.remote_user;
      debug('[middleware/allow][%o] allow for %o', action, remote === null || remote === void 0 ? void 0 : remote.name);
      auth['allow_' + action]({
        packageName,
        packageVersion
      }, remote, function (error, allowed) {
        req.resume();

        if (error) {
          next(error);
        } else if (allowed) {
          next();
        } else {
          // last plugin (that's our built-in one) returns either
          // cb(err) or cb(null, true), so this should never happen
          throw _utils.ErrorCode.getInternalError(_constants.API_ERROR.PLUGIN_ERROR);
        }
      });
    };
  };
}

function final(body, req, res, next) {
  if (res.statusCode === _constants.HTTP_STATUS.UNAUTHORIZED && !res.getHeader(_constants.HEADERS.WWW_AUTH)) {
    // they say it's required for 401, so...
    res.header(_constants.HEADERS.WWW_AUTH, `${_constants.TOKEN_BASIC}, ${_constants.TOKEN_BEARER}`);
  }

  try {
    if (_lodash.default.isString(body) || _lodash.default.isObject(body)) {
      if (!res.getHeader(_constants.HEADERS.CONTENT_TYPE)) {
        res.header(_constants.HEADERS.CONTENT_TYPE, _constants.HEADERS.JSON);
      }

      if (typeof body === 'object' && _lodash.default.isNil(body) === false) {
        if (typeof body.error === 'string') {
          res.locals._verdaccio_error = body.error;
        }

        body = JSON.stringify(body, undefined, '  ') + '\n';
      } // don't send etags with errors


      if (!res.statusCode || res.statusCode >= _constants.HTTP_STATUS.OK && res.statusCode < _constants.HTTP_STATUS.MULTIPLE_CHOICES) {
        res.header(_constants.HEADERS.ETAG, '"' + (0, _cryptoUtils.stringToMD5)(body) + '"');
      }
    } else {// send(null), send(204), etc.
    }
  } catch (err) {
    // if verdaccio sends headers first, and then calls res.send()
    // as an error handler, we can't report error properly,
    // and should just close socket
    if (err.message.match(/set headers after they are sent/)) {
      if (_lodash.default.isNil(res.socket) === false) {
        // @ts-ignore
        res.socket.destroy();
      }

      return;
    }

    throw err;
  }

  res.send(body);
}

const LOG_STATUS_MESSAGE = "@{status}, user: @{user}(@{remoteIP}), req: '@{request.method} @{request.url}'";
exports.LOG_STATUS_MESSAGE = LOG_STATUS_MESSAGE;
const LOG_VERDACCIO_ERROR = `${LOG_STATUS_MESSAGE}, error: @{!error}`;
exports.LOG_VERDACCIO_ERROR = LOG_VERDACCIO_ERROR;
const LOG_VERDACCIO_BYTES = `${LOG_STATUS_MESSAGE}, bytes: @{bytes.in}/@{bytes.out}`;
exports.LOG_VERDACCIO_BYTES = LOG_VERDACCIO_BYTES;

function log(config) {
  return function (req, res, next) {
    var _config$experiments;

    const _auth = req.headers.authorization;

    if (_lodash.default.isNil(_auth) === false) {
      req.headers.authorization = '<Classified>';
    }

    const _cookie = req.get('cookie');

    if (_lodash.default.isNil(_cookie) === false) {
      req.headers.cookie = '<Classified>';
    }

    req.url = req.originalUrl; // avoid log noise data from static content

    if (req.originalUrl.match(/static/) === null) {
      _logger.logger.http({
        req: req,
        ip: req.ip
      }, "@{ip} requested '@{req.method} @{req.url}'");
    }

    req.originalUrl = req.url;

    if (_lodash.default.isNil(_auth) === false) {
      req.headers.authorization = _auth;
    }

    if (_lodash.default.isNil(_cookie) === false) {
      req.headers.cookie = _cookie;
    }

    let bytesin = 0;

    if ((config === null || config === void 0 ? void 0 : (_config$experiments = config.experiments) === null || _config$experiments === void 0 ? void 0 : _config$experiments.bytesin_off) !== true) {
      req.on('data', function (chunk) {
        bytesin += chunk.length;
      });
    }

    let bytesout = 0;
    const _write = res.write; // FIXME: res.write should return boolean
    // @ts-ignore

    res.write = function (buf) {
      bytesout += buf.length;
      /* eslint prefer-rest-params: "off" */
      // @ts-ignore

      _write.apply(res, arguments);
    };

    let logHasBeenCalled = false;

    const log = function () {
      if (logHasBeenCalled) {
        return;
      }

      logHasBeenCalled = true;
      const forwardedFor = req.get('x-forwarded-for');
      const remoteAddress = req.connection.remoteAddress;
      const remoteIP = forwardedFor ? `${forwardedFor} via ${remoteAddress}` : remoteAddress;
      let message;

      if (res.locals._verdaccio_error) {
        message = LOG_VERDACCIO_ERROR;
      } else {
        message = LOG_VERDACCIO_BYTES;
      }

      req.url = req.originalUrl; // avoid log noise data from static content

      if (req.url.match(/static/) === null) {
        _logger.logger.http({
          request: {
            method: req.method,
            url: req.url
          },
          user: req.remote_user && req.remote_user.name || null,
          remoteIP,
          status: res.statusCode,
          error: res.locals._verdaccio_error,
          bytes: {
            in: bytesin,
            out: bytesout
          }
        }, message);

        req.originalUrl = req.url;
      }
    };

    req.on('close', function () {
      log();
    });
    const _end = res.end;

    res.end = function (buf) {
      if (buf) {
        bytesout += buf.length;
      }
      /* eslint prefer-rest-params: "off" */
      // @ts-ignore


      _end.apply(res, arguments);

      log();
    };

    next();
  };
} // Middleware


function errorReportingMiddleware(req, res, next) {
  res.locals.report_error = res.locals.report_error || function (err) {
    if (err.status && err.status >= _constants.HTTP_STATUS.BAD_REQUEST && err.status < 600) {
      if (!res.headersSent) {
        res.status(err.status);
        next({
          error: err.message || _constants.API_ERROR.UNKNOWN_ERROR
        });
      }
    } else {
      _logger.logger.error({
        err: err
      }, 'unexpected error: @{!err.message}\n@{err.stack}');

      if (!res.status || !res.send) {
        _logger.logger.error('this is an error in express.js, please report this');

        res.destroy();
      } else if (!res.headersSent) {
        res.status(_constants.HTTP_STATUS.INTERNAL_ERROR);
        next({
          error: _constants.API_ERROR.INTERNAL_SERVER_ERROR
        });
      } else {// socket should be already closed
      }
    }
  };

  next();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcGkvbWlkZGxld2FyZS50cyJdLCJuYW1lcyI6WyJkZWJ1ZyIsIm1hdGNoIiwicmVnZXhwIiwicmVxIiwicmVzIiwibmV4dCIsInZhbHVlIiwiZXhlYyIsInNlcnZlRmF2aWNvbiIsImNvbmZpZyIsImxvZ29Db25mIiwid2ViIiwiZmF2aWNvbiIsInN0YXR1cyIsIl8iLCJpc0VtcHR5IiwidmFsaWRhdG9yIiwiaXNVUkwiLCJyZXF1aXJlX2hvc3QiLCJyZXF1aXJlX3ZhbGlkX3Byb3RvY29sIiwicmVkaXJlY3QiLCJmYXZpY29uUGF0aCIsInBhdGgiLCJub3JtYWxpemUiLCJmcyIsImFjY2VzcyIsImNvbnN0YW50cyIsIlJfT0siLCJlcnIiLCJtZXNzYWdlIiwiSFRUUF9TVEFUVVMiLCJOT1RfRk9VTkQiLCJlbmQiLCJzZXRIZWFkZXIiLCJjcmVhdGVSZWFkU3RyZWFtIiwicGlwZSIsInBvc2l4Iiwiam9pbiIsIl9fZGlybmFtZSIsInNldFNlY3VyaXR5V2ViSGVhZGVycyIsImhlYWRlciIsIkhFQURFUlMiLCJGUkFNRVNfT1BUSU9OUyIsIkNTUCIsIkNUTyIsIlhTUyIsInZhbGlkYXRlTmFtZSIsIm5hbWUiLCJFcnJvckNvZGUiLCJnZXRGb3JiaWRkZW4iLCJ2YWxpZGF0ZVBhY2thZ2UiLCJtZWRpYSIsImV4cGVjdCIsImhlYWRlcnMiLCJIRUFERVJfVFlQRSIsIkNPTlRFTlRfVFlQRSIsImdldENvZGUiLCJVTlNVUFBPUlRFRF9NRURJQSIsImdldCIsImVuY29kZVNjb3BlUGFja2FnZSIsInVybCIsImluZGV4T2YiLCJyZXBsYWNlIiwiZXhwZWN0SnNvbiIsImJvZHkiLCJnZXRCYWRSZXF1ZXN0IiwiYW50aUxvb3AiLCJ2aWEiLCJhcnIiLCJzcGxpdCIsImkiLCJsZW5ndGgiLCJtIiwic2VydmVyX2lkIiwiTE9PUF9ERVRFQ1RFRCIsImFsbG93IiwiYXV0aCIsImFjdGlvbiIsInBhdXNlIiwicGFja2FnZU5hbWUiLCJwYXJhbXMiLCJzY29wZSIsInBhY2thZ2UiLCJwYWNrYWdlVmVyc2lvbiIsImZpbGVuYW1lIiwidW5kZWZpbmVkIiwicmVtb3RlIiwicmVtb3RlX3VzZXIiLCJlcnJvciIsImFsbG93ZWQiLCJyZXN1bWUiLCJnZXRJbnRlcm5hbEVycm9yIiwiQVBJX0VSUk9SIiwiUExVR0lOX0VSUk9SIiwiZmluYWwiLCJzdGF0dXNDb2RlIiwiVU5BVVRIT1JJWkVEIiwiZ2V0SGVhZGVyIiwiV1dXX0FVVEgiLCJUT0tFTl9CQVNJQyIsIlRPS0VOX0JFQVJFUiIsImlzU3RyaW5nIiwiaXNPYmplY3QiLCJKU09OIiwiaXNOaWwiLCJsb2NhbHMiLCJfdmVyZGFjY2lvX2Vycm9yIiwic3RyaW5naWZ5IiwiT0siLCJNVUxUSVBMRV9DSE9JQ0VTIiwiRVRBRyIsInNvY2tldCIsImRlc3Ryb3kiLCJzZW5kIiwiTE9HX1NUQVRVU19NRVNTQUdFIiwiTE9HX1ZFUkRBQ0NJT19FUlJPUiIsIkxPR19WRVJEQUNDSU9fQllURVMiLCJsb2ciLCJfYXV0aCIsImF1dGhvcml6YXRpb24iLCJfY29va2llIiwiY29va2llIiwib3JpZ2luYWxVcmwiLCJsb2dnZXIiLCJodHRwIiwiaXAiLCJieXRlc2luIiwiZXhwZXJpbWVudHMiLCJieXRlc2luX29mZiIsIm9uIiwiY2h1bmsiLCJieXRlc291dCIsIl93cml0ZSIsIndyaXRlIiwiYnVmIiwiYXBwbHkiLCJhcmd1bWVudHMiLCJsb2dIYXNCZWVuQ2FsbGVkIiwiZm9yd2FyZGVkRm9yIiwicmVtb3RlQWRkcmVzcyIsImNvbm5lY3Rpb24iLCJyZW1vdGVJUCIsInJlcXVlc3QiLCJtZXRob2QiLCJ1c2VyIiwiYnl0ZXMiLCJpbiIsIm91dCIsIl9lbmQiLCJlcnJvclJlcG9ydGluZ01pZGRsZXdhcmUiLCJyZXBvcnRfZXJyb3IiLCJCQURfUkVRVUVTVCIsImhlYWRlcnNTZW50IiwiVU5LTk9XTl9FUlJPUiIsIklOVEVSTkFMX0VSUk9SIiwiSU5URVJOQUxfU0VSVkVSX0VSUk9SIl0sIm1hcHBpbmdzIjoiOzs7Ozs7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QUFBLElBQUk7QUFDTCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgYnVpbGREZWJ1ZyBmcm9tICdkZWJ1Zyc7XG5pbXBvcnQgdmFsaWRhdG9yIGZyb20gJ3ZhbGlkYXRvcic7XG5cbmltcG9ydCB7IENvbmZpZywgUGFja2FnZSwgUmVtb3RlVXNlciB9IGZyb20gJ0B2ZXJkYWNjaW8vdHlwZXMnO1xuaW1wb3J0IHsgVmVyZGFjY2lvRXJyb3IgfSBmcm9tICdAdmVyZGFjY2lvL2NvbW1vbnMtYXBpJztcbmltcG9ydCB7IHZhbGlkYXRlTmFtZSBhcyB1dGlsVmFsaWRhdGVOYW1lLCB2YWxpZGF0ZVBhY2thZ2UgYXMgdXRpbFZhbGlkYXRlUGFja2FnZSwgZ2V0VmVyc2lvbkZyb21UYXJiYWxsLCBpc09iamVjdCwgRXJyb3JDb2RlIH0gZnJvbSAnLi4vbGliL3V0aWxzJztcbmltcG9ydCB7IEFQSV9FUlJPUiwgSEVBREVSX1RZUEUsIEhFQURFUlMsIEhUVFBfU1RBVFVTLCBUT0tFTl9CQVNJQywgVE9LRU5fQkVBUkVSIH0gZnJvbSAnLi4vbGliL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBzdHJpbmdUb01ENSB9IGZyb20gJy4uL2xpYi9jcnlwdG8tdXRpbHMnO1xuaW1wb3J0IHsgJFJlc3BvbnNlRXh0ZW5kLCAkUmVxdWVzdEV4dGVuZCwgJE5leHRGdW5jdGlvblZlciwgSUF1dGggfSBmcm9tICcuLi8uLi90eXBlcyc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcuLi9saWIvbG9nZ2VyJztcblxuY29uc3QgZGVidWcgPSBidWlsZERlYnVnKCd2ZXJkYWNjaW8nKTtcblxuZXhwb3J0IGZ1bmN0aW9uIG1hdGNoKHJlZ2V4cDogUmVnRXhwKTogYW55IHtcbiAgcmV0dXJuIGZ1bmN0aW9uIChyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6ICRSZXNwb25zZUV4dGVuZCwgbmV4dDogJE5leHRGdW5jdGlvblZlciwgdmFsdWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChyZWdleHAuZXhlYyh2YWx1ZSkpIHtcbiAgICAgIG5leHQoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbmV4dCgncm91dGUnKTtcbiAgICB9XG4gIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXJ2ZUZhdmljb24oY29uZmlnOiBDb25maWcpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIChyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6ICRSZXNwb25zZUV4dGVuZCwgbmV4dDogJE5leHRGdW5jdGlvblZlcikge1xuICAgIHRyeSB7XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBjb25zdCBsb2dvQ29uZjogc3RyaW5nID0gY29uZmlnPy53ZWI/LmZhdmljb24gYXMgc3RyaW5nO1xuICAgICAgaWYgKGxvZ29Db25mID09PSAnJykge1xuICAgICAgICBkZWJ1ZygnZmF2aWNvbiBkaXNhYmxlZCcpO1xuICAgICAgICByZXMuc3RhdHVzKDQwNCk7XG4gICAgICB9IGVsc2UgaWYgKCFfLmlzRW1wdHkobG9nb0NvbmYpKSB7XG4gICAgICAgIGRlYnVnKCdjdXN0b20gZmF2aWNvbicpO1xuICAgICAgICBpZiAoXG4gICAgICAgICAgdmFsaWRhdG9yLmlzVVJMKGxvZ29Db25mLCB7XG4gICAgICAgICAgICByZXF1aXJlX2hvc3Q6IHRydWUsXG4gICAgICAgICAgICByZXF1aXJlX3ZhbGlkX3Byb3RvY29sOiB0cnVlLFxuICAgICAgICAgIH0pXG4gICAgICAgICkge1xuICAgICAgICAgIGRlYnVnKCdyZWRpcmVjdCB0byAlbycsIGxvZ29Db25mKTtcbiAgICAgICAgICByZXMucmVkaXJlY3QobG9nb0NvbmYpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBmYXZpY29uUGF0aCA9IHBhdGgubm9ybWFsaXplKGxvZ29Db25mKTtcbiAgICAgICAgICBkZWJ1Zygnc2VydmluZyBmYXZpY29uIGZyb20gJW8nLCBmYXZpY29uUGF0aCk7XG4gICAgICAgICAgZnMuYWNjZXNzKGZhdmljb25QYXRoLCBmcy5jb25zdGFudHMuUl9PSywgKGVycikgPT4ge1xuICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICBkZWJ1Zygnbm8gcmVhZCBwZXJtaXNzaW9ucyB0byByZWFkOiAlbywgcmVhc29uOicsIGxvZ29Db25mLCBlcnI/Lm1lc3NhZ2UpO1xuICAgICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyhIVFRQX1NUQVRVUy5OT1RfRk9VTkQpLmVuZCgpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzLnNldEhlYWRlcignY29udGVudC10eXBlJywgJ2ltYWdlL3gtaWNvbicpO1xuICAgICAgICAgICAgICBmcy5jcmVhdGVSZWFkU3RyZWFtKGZhdmljb25QYXRoKS5waXBlKHJlcyk7XG4gICAgICAgICAgICAgIGRlYnVnKCdyZW5kZXJlZCBjdXN0b20gaWNvJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlcy5zZXRIZWFkZXIoJ2NvbnRlbnQtdHlwZScsICdpbWFnZS94LWljb24nKTtcbiAgICAgICAgZnMuY3JlYXRlUmVhZFN0cmVhbShwYXRoLnBvc2l4LmpvaW4oX19kaXJuYW1lLCAnLi93ZWIvaHRtbC9mYXZpY29uLmljbycpKS5waXBlKHJlcyk7XG4gICAgICAgIGRlYnVnKCdyZW5kZXJlZCBpY28nKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGRlYnVnKCdlcnJvciB0cmlnZ2VyZWQsIGZhdmljb24gbm90IGZvdW5kJyk7XG4gICAgICByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLk5PVF9GT1VORCkuZW5kKCk7XG4gICAgfVxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0U2VjdXJpdHlXZWJIZWFkZXJzKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gIC8vIGRpc2FibGUgbG9hZGluZyBpbiBmcmFtZXMgKGNsaWNramFja2luZywgZXRjLilcbiAgcmVzLmhlYWRlcihIRUFERVJTLkZSQU1FU19PUFRJT05TLCAnZGVueScpO1xuICAvLyBhdm9pZCBzdGFibGlzaCBjb25uZWN0aW9ucyBvdXRzaWRlIG9mIGRvbWFpblxuICByZXMuaGVhZGVyKEhFQURFUlMuQ1NQLCBcImNvbm5lY3Qtc3JjICdzZWxmJ1wiKTtcbiAgLy8gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTgzMzc2MzAvd2hhdC1pcy14LWNvbnRlbnQtdHlwZS1vcHRpb25zLW5vc25pZmZcbiAgcmVzLmhlYWRlcihIRUFERVJTLkNUTywgJ25vc25pZmYnKTtcbiAgLy8gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvOTA5MDU3Ny93aGF0LWlzLXRoZS1odHRwLWhlYWRlci14LXhzcy1wcm90ZWN0aW9uXG4gIHJlcy5oZWFkZXIoSEVBREVSUy5YU1MsICcxOyBtb2RlPWJsb2NrJyk7XG4gIG5leHQoKTtcbn1cblxuLy8gZmxvdzogZXhwcmVzcyBkb2VzIG5vdCBtYXRjaCBwcm9wZXJseVxuLy8gZmxvdyBpbmZvIGh0dHBzOi8vZ2l0aHViLmNvbS9mbG93dHlwZS9mbG93LXR5cGVkL2lzc3Vlcz91dGY4PSVFMiU5QyU5MyZxPWlzJTNBaXNzdWUraXMlM0FvcGVuK2V4cHJlc3NcbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZU5hbWUocmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiAkUmVzcG9uc2VFeHRlbmQsIG5leHQ6ICROZXh0RnVuY3Rpb25WZXIsIHZhbHVlOiBzdHJpbmcsIG5hbWU6IHN0cmluZyk6IHZvaWQge1xuICBpZiAodmFsdWUgPT09ICctJykge1xuICAgIC8vIHNwZWNpYWwgY2FzZSBpbiBjb3VjaGRiIHVzdWFsbHlcbiAgICBuZXh0KCdyb3V0ZScpO1xuICB9IGVsc2UgaWYgKHV0aWxWYWxpZGF0ZU5hbWUodmFsdWUpKSB7XG4gICAgbmV4dCgpO1xuICB9IGVsc2Uge1xuICAgIG5leHQoRXJyb3JDb2RlLmdldEZvcmJpZGRlbignaW52YWxpZCAnICsgbmFtZSkpO1xuICB9XG59XG5cbi8vIGZsb3c6IGV4cHJlc3MgZG9lcyBub3QgbWF0Y2ggcHJvcGVybHlcbi8vIGZsb3cgaW5mbyBodHRwczovL2dpdGh1Yi5jb20vZmxvd3R5cGUvZmxvdy10eXBlZC9pc3N1ZXM/dXRmOD0lRTIlOUMlOTMmcT1pcyUzQWlzc3VlK2lzJTNBb3BlbitleHByZXNzXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVQYWNrYWdlKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyLCB2YWx1ZTogc3RyaW5nLCBuYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgaWYgKHZhbHVlID09PSAnLScpIHtcbiAgICAvLyBzcGVjaWFsIGNhc2UgaW4gY291Y2hkYiB1c3VhbGx5XG4gICAgbmV4dCgncm91dGUnKTtcbiAgfSBlbHNlIGlmICh1dGlsVmFsaWRhdGVQYWNrYWdlKHZhbHVlKSkge1xuICAgIG5leHQoKTtcbiAgfSBlbHNlIHtcbiAgICBuZXh0KEVycm9yQ29kZS5nZXRGb3JiaWRkZW4oJ2ludmFsaWQgJyArIG5hbWUpKTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVkaWEoZXhwZWN0OiBzdHJpbmcgfCBudWxsKTogYW55IHtcbiAgcmV0dXJuIGZ1bmN0aW9uIChyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6ICRSZXNwb25zZUV4dGVuZCwgbmV4dDogJE5leHRGdW5jdGlvblZlcik6IHZvaWQge1xuICAgIGlmIChyZXEuaGVhZGVyc1tIRUFERVJfVFlQRS5DT05URU5UX1RZUEVdICE9PSBleHBlY3QpIHtcbiAgICAgIG5leHQoRXJyb3JDb2RlLmdldENvZGUoSFRUUF9TVEFUVVMuVU5TVVBQT1JURURfTUVESUEsICd3cm9uZyBjb250ZW50LXR5cGUsIGV4cGVjdDogJyArIGV4cGVjdCArICcsIGdvdDogJyArIHJlcS5nZXQoSEVBREVSX1RZUEUuQ09OVEVOVF9UWVBFKSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBuZXh0KCk7XG4gICAgfVxuICB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZW5jb2RlU2NvcGVQYWNrYWdlKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gIGlmIChyZXEudXJsLmluZGV4T2YoJ0AnKSAhPT0gLTEpIHtcbiAgICAvLyBlLmcuOiAvQG9yZy9wa2cvMS4yLjMgLT4gL0BvcmclMkZwa2cvMS4yLjMsIC9Ab3JnJTJGcGtnLzEuMi4zIC0+IC9Ab3JnJTJGcGtnLzEuMi4zXG4gICAgcmVxLnVybCA9IHJlcS51cmwucmVwbGFjZSgvXihcXC9AW15cXC8lXSspXFwvKD8hJCkvLCAnJDElMkYnKTtcbiAgfVxuICBuZXh0KCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBleHBlY3RKc29uKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gIGlmICghaXNPYmplY3QocmVxLmJvZHkpKSB7XG4gICAgcmV0dXJuIG5leHQoRXJyb3JDb2RlLmdldEJhZFJlcXVlc3QoXCJjYW4ndCBwYXJzZSBpbmNvbWluZyBqc29uXCIpKTtcbiAgfVxuICBuZXh0KCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhbnRpTG9vcChjb25maWc6IENvbmZpZyk6IEZ1bmN0aW9uIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIChyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6ICRSZXNwb25zZUV4dGVuZCwgbmV4dDogJE5leHRGdW5jdGlvblZlcik6IHZvaWQge1xuICAgIGlmIChyZXE/LmhlYWRlcnM/LnZpYSAhPSBudWxsKSB7XG4gICAgICBjb25zdCBhcnIgPSByZXEuaGVhZGVycy52aWEuc3BsaXQoJywnKTtcblxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgY29uc3QgbSA9IGFycltpXS5tYXRjaCgvXFxzKihcXFMrKVxccysoXFxTKykvKTtcbiAgICAgICAgaWYgKG0gJiYgbVsyXSA9PT0gY29uZmlnLnNlcnZlcl9pZCkge1xuICAgICAgICAgIHJldHVybiBuZXh0KEVycm9yQ29kZS5nZXRDb2RlKEhUVFBfU1RBVFVTLkxPT1BfREVURUNURUQsICdsb29wIGRldGVjdGVkJykpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIG5leHQoKTtcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFsbG93KGF1dGg6IElBdXRoKTogRnVuY3Rpb24ge1xuICByZXR1cm4gZnVuY3Rpb24gKGFjdGlvbjogc3RyaW5nKTogRnVuY3Rpb24ge1xuICAgIHJldHVybiBmdW5jdGlvbiAocmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiAkUmVzcG9uc2VFeHRlbmQsIG5leHQ6ICROZXh0RnVuY3Rpb25WZXIpOiB2b2lkIHtcbiAgICAgIHJlcS5wYXVzZSgpO1xuICAgICAgY29uc3QgcGFja2FnZU5hbWUgPSByZXEucGFyYW1zLnNjb3BlID8gYEAke3JlcS5wYXJhbXMuc2NvcGV9LyR7cmVxLnBhcmFtcy5wYWNrYWdlfWAgOiByZXEucGFyYW1zLnBhY2thZ2U7XG4gICAgICBjb25zdCBwYWNrYWdlVmVyc2lvbiA9IHJlcS5wYXJhbXMuZmlsZW5hbWUgPyBnZXRWZXJzaW9uRnJvbVRhcmJhbGwocmVxLnBhcmFtcy5maWxlbmFtZSkgOiB1bmRlZmluZWQ7XG4gICAgICBjb25zdCByZW1vdGU6IFJlbW90ZVVzZXIgPSByZXEucmVtb3RlX3VzZXI7XG4gICAgICBkZWJ1ZygnW21pZGRsZXdhcmUvYWxsb3ddWyVvXSBhbGxvdyBmb3IgJW8nLCBhY3Rpb24sIHJlbW90ZT8ubmFtZSk7XG4gICAgICBhdXRoWydhbGxvd18nICsgYWN0aW9uXSh7IHBhY2thZ2VOYW1lLCBwYWNrYWdlVmVyc2lvbiB9LCByZW1vdGUsIGZ1bmN0aW9uIChlcnJvciwgYWxsb3dlZCk6IHZvaWQge1xuICAgICAgICByZXEucmVzdW1lKCk7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgIG5leHQoZXJyb3IpO1xuICAgICAgICB9IGVsc2UgaWYgKGFsbG93ZWQpIHtcbiAgICAgICAgICBuZXh0KCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gbGFzdCBwbHVnaW4gKHRoYXQncyBvdXIgYnVpbHQtaW4gb25lKSByZXR1cm5zIGVpdGhlclxuICAgICAgICAgIC8vIGNiKGVycikgb3IgY2IobnVsbCwgdHJ1ZSksIHNvIHRoaXMgc2hvdWxkIG5ldmVyIGhhcHBlblxuICAgICAgICAgIHRocm93IEVycm9yQ29kZS5nZXRJbnRlcm5hbEVycm9yKEFQSV9FUlJPUi5QTFVHSU5fRVJST1IpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9O1xuICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1pZGRsZXdhcmVFcnJvciB7XG4gIGVycm9yOiBzdHJpbmc7XG59XG5cbmV4cG9ydCB0eXBlIEZpbmFsQm9keSA9IFBhY2thZ2UgfCBNaWRkbGV3YXJlRXJyb3IgfCBzdHJpbmc7XG5cbmV4cG9ydCBmdW5jdGlvbiBmaW5hbChib2R5OiBGaW5hbEJvZHksIHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gIGlmIChyZXMuc3RhdHVzQ29kZSA9PT0gSFRUUF9TVEFUVVMuVU5BVVRIT1JJWkVEICYmICFyZXMuZ2V0SGVhZGVyKEhFQURFUlMuV1dXX0FVVEgpKSB7XG4gICAgLy8gdGhleSBzYXkgaXQncyByZXF1aXJlZCBmb3IgNDAxLCBzby4uLlxuICAgIHJlcy5oZWFkZXIoSEVBREVSUy5XV1dfQVVUSCwgYCR7VE9LRU5fQkFTSUN9LCAke1RPS0VOX0JFQVJFUn1gKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgaWYgKF8uaXNTdHJpbmcoYm9keSkgfHwgXy5pc09iamVjdChib2R5KSkge1xuICAgICAgaWYgKCFyZXMuZ2V0SGVhZGVyKEhFQURFUlMuQ09OVEVOVF9UWVBFKSkge1xuICAgICAgICByZXMuaGVhZGVyKEhFQURFUlMuQ09OVEVOVF9UWVBFLCBIRUFERVJTLkpTT04pO1xuICAgICAgfVxuXG4gICAgICBpZiAodHlwZW9mIGJvZHkgPT09ICdvYmplY3QnICYmIF8uaXNOaWwoYm9keSkgPT09IGZhbHNlKSB7XG4gICAgICAgIGlmICh0eXBlb2YgKGJvZHkgYXMgTWlkZGxld2FyZUVycm9yKS5lcnJvciA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICByZXMubG9jYWxzLl92ZXJkYWNjaW9fZXJyb3IgPSAoYm9keSBhcyBNaWRkbGV3YXJlRXJyb3IpLmVycm9yO1xuICAgICAgICB9XG4gICAgICAgIGJvZHkgPSBKU09OLnN0cmluZ2lmeShib2R5LCB1bmRlZmluZWQsICcgICcpICsgJ1xcbic7XG4gICAgICB9XG5cbiAgICAgIC8vIGRvbid0IHNlbmQgZXRhZ3Mgd2l0aCBlcnJvcnNcbiAgICAgIGlmICghcmVzLnN0YXR1c0NvZGUgfHwgKHJlcy5zdGF0dXNDb2RlID49IEhUVFBfU1RBVFVTLk9LICYmIHJlcy5zdGF0dXNDb2RlIDwgSFRUUF9TVEFUVVMuTVVMVElQTEVfQ0hPSUNFUykpIHtcbiAgICAgICAgcmVzLmhlYWRlcihIRUFERVJTLkVUQUcsICdcIicgKyBzdHJpbmdUb01ENShib2R5IGFzIHN0cmluZykgKyAnXCInKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gc2VuZChudWxsKSwgc2VuZCgyMDQpLCBldGMuXG4gICAgfVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyBpZiB2ZXJkYWNjaW8gc2VuZHMgaGVhZGVycyBmaXJzdCwgYW5kIHRoZW4gY2FsbHMgcmVzLnNlbmQoKVxuICAgIC8vIGFzIGFuIGVycm9yIGhhbmRsZXIsIHdlIGNhbid0IHJlcG9ydCBlcnJvciBwcm9wZXJseSxcbiAgICAvLyBhbmQgc2hvdWxkIGp1c3QgY2xvc2Ugc29ja2V0XG4gICAgaWYgKGVyci5tZXNzYWdlLm1hdGNoKC9zZXQgaGVhZGVycyBhZnRlciB0aGV5IGFyZSBzZW50LykpIHtcbiAgICAgIGlmIChfLmlzTmlsKHJlcy5zb2NrZXQpID09PSBmYWxzZSkge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHJlcy5zb2NrZXQuZGVzdHJveSgpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cblxuICByZXMuc2VuZChib2R5KTtcbn1cblxuZXhwb3J0IGNvbnN0IExPR19TVEFUVVNfTUVTU0FHRSA9IFwiQHtzdGF0dXN9LCB1c2VyOiBAe3VzZXJ9KEB7cmVtb3RlSVB9KSwgcmVxOiAnQHtyZXF1ZXN0Lm1ldGhvZH0gQHtyZXF1ZXN0LnVybH0nXCI7XG5leHBvcnQgY29uc3QgTE9HX1ZFUkRBQ0NJT19FUlJPUiA9IGAke0xPR19TVEFUVVNfTUVTU0FHRX0sIGVycm9yOiBAeyFlcnJvcn1gO1xuZXhwb3J0IGNvbnN0IExPR19WRVJEQUNDSU9fQllURVMgPSBgJHtMT0dfU1RBVFVTX01FU1NBR0V9LCBieXRlczogQHtieXRlcy5pbn0vQHtieXRlcy5vdXR9YDtcblxuZXhwb3J0IGZ1bmN0aW9uIGxvZyhjb25maWc6IENvbmZpZykge1xuICByZXR1cm4gZnVuY3Rpb24gKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gICAgY29uc3QgX2F1dGggPSByZXEuaGVhZGVycy5hdXRob3JpemF0aW9uO1xuICAgIGlmIChfLmlzTmlsKF9hdXRoKSA9PT0gZmFsc2UpIHtcbiAgICAgIHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb24gPSAnPENsYXNzaWZpZWQ+JztcbiAgICB9XG5cbiAgICBjb25zdCBfY29va2llID0gcmVxLmdldCgnY29va2llJyk7XG4gICAgaWYgKF8uaXNOaWwoX2Nvb2tpZSkgPT09IGZhbHNlKSB7XG4gICAgICByZXEuaGVhZGVycy5jb29raWUgPSAnPENsYXNzaWZpZWQ+JztcbiAgICB9XG5cbiAgICByZXEudXJsID0gcmVxLm9yaWdpbmFsVXJsO1xuICAgIC8vIGF2b2lkIGxvZyBub2lzZSBkYXRhIGZyb20gc3RhdGljIGNvbnRlbnRcbiAgICBpZiAocmVxLm9yaWdpbmFsVXJsLm1hdGNoKC9zdGF0aWMvKSA9PT0gbnVsbCkge1xuICAgICAgbG9nZ2VyLmh0dHAoeyByZXE6IHJlcSwgaXA6IHJlcS5pcCB9LCBcIkB7aXB9IHJlcXVlc3RlZCAnQHtyZXEubWV0aG9kfSBAe3JlcS51cmx9J1wiKTtcbiAgICB9XG4gICAgcmVxLm9yaWdpbmFsVXJsID0gcmVxLnVybDtcblxuICAgIGlmIChfLmlzTmlsKF9hdXRoKSA9PT0gZmFsc2UpIHtcbiAgICAgIHJlcS5oZWFkZXJzLmF1dGhvcml6YXRpb24gPSBfYXV0aDtcbiAgICB9XG5cbiAgICBpZiAoXy5pc05pbChfY29va2llKSA9PT0gZmFsc2UpIHtcbiAgICAgIHJlcS5oZWFkZXJzLmNvb2tpZSA9IF9jb29raWU7XG4gICAgfVxuXG4gICAgbGV0IGJ5dGVzaW4gPSAwO1xuICAgIGlmIChjb25maWc/LmV4cGVyaW1lbnRzPy5ieXRlc2luX29mZiAhPT0gdHJ1ZSkge1xuICAgICAgcmVxLm9uKCdkYXRhJywgZnVuY3Rpb24gKGNodW5rKTogdm9pZCB7XG4gICAgICAgIGJ5dGVzaW4gKz0gY2h1bmsubGVuZ3RoO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgbGV0IGJ5dGVzb3V0ID0gMDtcbiAgICBjb25zdCBfd3JpdGUgPSByZXMud3JpdGU7XG4gICAgLy8gRklYTUU6IHJlcy53cml0ZSBzaG91bGQgcmV0dXJuIGJvb2xlYW5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcmVzLndyaXRlID0gZnVuY3Rpb24gKGJ1Zik6IGJvb2xlYW4ge1xuICAgICAgYnl0ZXNvdXQgKz0gYnVmLmxlbmd0aDtcbiAgICAgIC8qIGVzbGludCBwcmVmZXItcmVzdC1wYXJhbXM6IFwib2ZmXCIgKi9cbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIF93cml0ZS5hcHBseShyZXMsIGFyZ3VtZW50cyk7XG4gICAgfTtcblxuICAgIGxldCBsb2dIYXNCZWVuQ2FsbGVkID0gZmFsc2U7XG4gICAgY29uc3QgbG9nID0gZnVuY3Rpb24gKCk6IHZvaWQge1xuICAgICAgaWYgKGxvZ0hhc0JlZW5DYWxsZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgbG9nSGFzQmVlbkNhbGxlZCA9IHRydWU7XG5cbiAgICAgIGNvbnN0IGZvcndhcmRlZEZvciA9IHJlcS5nZXQoJ3gtZm9yd2FyZGVkLWZvcicpO1xuICAgICAgY29uc3QgcmVtb3RlQWRkcmVzcyA9IHJlcS5jb25uZWN0aW9uLnJlbW90ZUFkZHJlc3M7XG4gICAgICBjb25zdCByZW1vdGVJUCA9IGZvcndhcmRlZEZvciA/IGAke2ZvcndhcmRlZEZvcn0gdmlhICR7cmVtb3RlQWRkcmVzc31gIDogcmVtb3RlQWRkcmVzcztcbiAgICAgIGxldCBtZXNzYWdlO1xuICAgICAgaWYgKHJlcy5sb2NhbHMuX3ZlcmRhY2Npb19lcnJvcikge1xuICAgICAgICBtZXNzYWdlID0gTE9HX1ZFUkRBQ0NJT19FUlJPUjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG1lc3NhZ2UgPSBMT0dfVkVSREFDQ0lPX0JZVEVTO1xuICAgICAgfVxuXG4gICAgICByZXEudXJsID0gcmVxLm9yaWdpbmFsVXJsO1xuICAgICAgLy8gYXZvaWQgbG9nIG5vaXNlIGRhdGEgZnJvbSBzdGF0aWMgY29udGVudFxuICAgICAgaWYgKHJlcS51cmwubWF0Y2goL3N0YXRpYy8pID09PSBudWxsKSB7XG4gICAgICAgIGxvZ2dlci5odHRwKFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHJlcXVlc3Q6IHtcbiAgICAgICAgICAgICAgbWV0aG9kOiByZXEubWV0aG9kLFxuICAgICAgICAgICAgICB1cmw6IHJlcS51cmwsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdXNlcjogKHJlcS5yZW1vdGVfdXNlciAmJiByZXEucmVtb3RlX3VzZXIubmFtZSkgfHwgbnVsbCxcbiAgICAgICAgICAgIHJlbW90ZUlQLFxuICAgICAgICAgICAgc3RhdHVzOiByZXMuc3RhdHVzQ29kZSxcbiAgICAgICAgICAgIGVycm9yOiByZXMubG9jYWxzLl92ZXJkYWNjaW9fZXJyb3IsXG4gICAgICAgICAgICBieXRlczoge1xuICAgICAgICAgICAgICBpbjogYnl0ZXNpbixcbiAgICAgICAgICAgICAgb3V0OiBieXRlc291dCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBtZXNzYWdlXG4gICAgICAgICk7XG4gICAgICAgIHJlcS5vcmlnaW5hbFVybCA9IHJlcS51cmw7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHJlcS5vbignY2xvc2UnLCBmdW5jdGlvbiAoKTogdm9pZCB7XG4gICAgICBsb2coKTtcbiAgICB9KTtcblxuICAgIGNvbnN0IF9lbmQgPSByZXMuZW5kO1xuICAgIHJlcy5lbmQgPSBmdW5jdGlvbiAoYnVmKTogdm9pZCB7XG4gICAgICBpZiAoYnVmKSB7XG4gICAgICAgIGJ5dGVzb3V0ICs9IGJ1Zi5sZW5ndGg7XG4gICAgICB9XG4gICAgICAvKiBlc2xpbnQgcHJlZmVyLXJlc3QtcGFyYW1zOiBcIm9mZlwiICovXG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICBfZW5kLmFwcGx5KHJlcywgYXJndW1lbnRzKTtcbiAgICAgIGxvZygpO1xuICAgIH07XG4gICAgbmV4dCgpO1xuICB9O1xufVxuXG4vLyBNaWRkbGV3YXJlXG5leHBvcnQgZnVuY3Rpb24gZXJyb3JSZXBvcnRpbmdNaWRkbGV3YXJlKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gIHJlcy5sb2NhbHMucmVwb3J0X2Vycm9yID1cbiAgICByZXMubG9jYWxzLnJlcG9ydF9lcnJvciB8fFxuICAgIGZ1bmN0aW9uIChlcnI6IFZlcmRhY2Npb0Vycm9yKTogdm9pZCB7XG4gICAgICBpZiAoZXJyLnN0YXR1cyAmJiBlcnIuc3RhdHVzID49IEhUVFBfU1RBVFVTLkJBRF9SRVFVRVNUICYmIGVyci5zdGF0dXMgPCA2MDApIHtcbiAgICAgICAgaWYgKCFyZXMuaGVhZGVyc1NlbnQpIHtcbiAgICAgICAgICByZXMuc3RhdHVzKGVyci5zdGF0dXMpO1xuICAgICAgICAgIG5leHQoeyBlcnJvcjogZXJyLm1lc3NhZ2UgfHwgQVBJX0VSUk9SLlVOS05PV05fRVJST1IgfSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcih7IGVycjogZXJyIH0sICd1bmV4cGVjdGVkIGVycm9yOiBAeyFlcnIubWVzc2FnZX1cXG5Ae2Vyci5zdGFja30nKTtcbiAgICAgICAgaWYgKCFyZXMuc3RhdHVzIHx8ICFyZXMuc2VuZCkge1xuICAgICAgICAgIGxvZ2dlci5lcnJvcigndGhpcyBpcyBhbiBlcnJvciBpbiBleHByZXNzLmpzLCBwbGVhc2UgcmVwb3J0IHRoaXMnKTtcbiAgICAgICAgICByZXMuZGVzdHJveSgpO1xuICAgICAgICB9IGVsc2UgaWYgKCFyZXMuaGVhZGVyc1NlbnQpIHtcbiAgICAgICAgICByZXMuc3RhdHVzKEhUVFBfU1RBVFVTLklOVEVSTkFMX0VSUk9SKTtcbiAgICAgICAgICBuZXh0KHsgZXJyb3I6IEFQSV9FUlJPUi5JTlRFUk5BTF9TRVJWRVJfRVJST1IgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gc29ja2V0IHNob3VsZCBiZSBhbHJlYWR5IGNsb3NlZFxuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcblxuICBuZXh0KCk7XG59XG4iXX0=