"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

var _lodash = _interopRequireDefault(require("lodash"));

var _middleware = require("../../middleware");

var _utils = require("../../../lib/utils");

var _constants = require("../../../lib/constants");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const downloadStream = (packageName, filename, storage, req, res) => {
  const stream = storage.getTarball(packageName, filename);
  stream.on('content-length', function (content) {
    res.header('Content-Length', content);
  });
  stream.on('error', function (err) {
    return res.locals.report_error(err);
  });
  res.header(_constants.HEADERS.CONTENT_TYPE, _constants.HEADERS.OCTET_STREAM);
  stream.pipe(res);
};

const redirectOrDownloadStream = (packageName, filename, storage, req, res, config) => {
  const tarballUrlRedirect = _lodash.default.get(config, 'experiments.tarball_url_redirect');

  storage.hasLocalTarball(packageName, filename).then(hasLocalTarball => {
    if (hasLocalTarball) {
      const context = {
        packageName,
        filename
      };
      const tarballUrl = typeof tarballUrlRedirect === 'function' ? tarballUrlRedirect(context) : _lodash.default.template(tarballUrlRedirect)(context);
      res.redirect(tarballUrl);
    } else {
      downloadStream(packageName, filename, storage, req, res);
    }
  }).catch(err => {
    res.locals.report_error(err);
  });
};

function _default(route, auth, storage, config) {
  const can = (0, _middleware.allow)(auth); // TODO: anonymous user?

  route.get('/:package/:version?', can('access'), function (req, res, next) {
    const getPackageMetaCallback = function (err, metadata) {
      if (err) {
        return next(err);
      }

      metadata = (0, _utils.convertDistRemoteToLocalTarballUrls)(metadata, req, config.url_prefix);
      let queryVersion = req.params.version;

      if (_lodash.default.isNil(queryVersion)) {
        return next(metadata);
      }

      let version = (0, _utils.getVersion)(metadata, queryVersion);

      if (_lodash.default.isNil(version) === false) {
        return next(version);
      }

      if (_lodash.default.isNil(metadata[_constants.DIST_TAGS]) === false) {
        if (_lodash.default.isNil(metadata[_constants.DIST_TAGS][queryVersion]) === false) {
          queryVersion = metadata[_constants.DIST_TAGS][queryVersion];
          version = (0, _utils.getVersion)(metadata, queryVersion);

          if (_lodash.default.isNil(version) === false) {
            return next(version);
          }
        }
      }

      return next(_utils.ErrorCode.getNotFound(`${_constants.API_ERROR.VERSION_NOT_EXIST}: ${req.params.version}`));
    };

    storage.getPackage({
      name: req.params.package,
      uplinksLook: true,
      req,
      callback: getPackageMetaCallback
    });
  });
  route.get('/:scopedPackage/-/:scope/:filename', can('access'), function (req, res) {
    const {
      scopedPackage,
      filename
    } = req.params;

    if (_lodash.default.get(config, 'experiments.tarball_url_redirect') === undefined) {
      downloadStream(scopedPackage, filename, storage, req, res);
    } else {
      redirectOrDownloadStream(scopedPackage, filename, storage, req, res, config);
    }
  });
  route.get('/:package/-/:filename', can('access'), function (req, res) {
    if (_lodash.default.get(config, 'experiments.tarball_url_redirect') === undefined) {
      downloadStream(req.params.package, req.params.filename, storage, req, res);
    } else {
      redirectOrDownloadStream(req.params.package, req.params.filename, storage, req, res, config);
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9hcGkvZW5kcG9pbnQvYXBpL3BhY2thZ2UudHMiXSwibmFtZXMiOlsiZG93bmxvYWRTdHJlYW0iLCJwYWNrYWdlTmFtZSIsImZpbGVuYW1lIiwic3RvcmFnZSIsInJlcSIsInJlcyIsInN0cmVhbSIsImdldFRhcmJhbGwiLCJvbiIsImNvbnRlbnQiLCJoZWFkZXIiLCJlcnIiLCJsb2NhbHMiLCJyZXBvcnRfZXJyb3IiLCJIRUFERVJTIiwiQ09OVEVOVF9UWVBFIiwiT0NURVRfU1RSRUFNIiwicGlwZSIsInJlZGlyZWN0T3JEb3dubG9hZFN0cmVhbSIsImNvbmZpZyIsInRhcmJhbGxVcmxSZWRpcmVjdCIsIl8iLCJnZXQiLCJoYXNMb2NhbFRhcmJhbGwiLCJ0aGVuIiwiY29udGV4dCIsInRhcmJhbGxVcmwiLCJ0ZW1wbGF0ZSIsInJlZGlyZWN0IiwiY2F0Y2giLCJyb3V0ZSIsImF1dGgiLCJjYW4iLCJuZXh0IiwiZ2V0UGFja2FnZU1ldGFDYWxsYmFjayIsIm1ldGFkYXRhIiwidXJsX3ByZWZpeCIsInF1ZXJ5VmVyc2lvbiIsInBhcmFtcyIsInZlcnNpb24iLCJpc05pbCIsIkRJU1RfVEFHUyIsIkVycm9yQ29kZSIsImdldE5vdEZvdW5kIiwiQVBJX0VSUk9SIiwiVkVSU0lPTl9OT1RfRVhJU1QiLCJnZXRQYWNrYWdlIiwibmFtZSIsInBhY2thZ2UiLCJ1cGxpbmtzTG9vayIsImNhbGxiYWNrIiwic2NvcGVkUGFja2FnZSIsInVuZGVmaW5lZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUdBOztBQUNBOztBQUNBOzs7O0FBU0EsTUFBTUEsY0FBYyxHQUFHLENBQ3JCQyxXQURxQixFQUVyQkMsUUFGcUIsRUFHckJDLE9BSHFCLEVBSXJCQyxHQUpxQixFQUtyQkMsR0FMcUIsS0FNWjtBQUNULFFBQU1DLE1BQU0sR0FBR0gsT0FBTyxDQUFDSSxVQUFSLENBQW1CTixXQUFuQixFQUFnQ0MsUUFBaEMsQ0FBZjtBQUVBSSxFQUFB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QUFjLGtDQUFkLE1BQXNEaUMsU0FBMUQsRUFBcUU7QUFDbkVwRCxNQUFBQSxjQUFjLENBQUNtRCxhQUFELEVBQWdCakQsUUFBaEIsRUFBMEJDLE9BQTFCLEVBQW1DQyxHQUFuQyxFQUF3Q0MsR0FBeEMsQ0FBZDtBQUNELEtBRkQsTUFFTztBQUNMYSxNQUFBQSx3QkFBd0IsQ0FBQ2lDLGFBQUQsRUFBZ0JqRCxRQUFoQixFQUEwQkMsT0FBMUIsRUFBbUNDLEdBQW5DLEVBQXdDQyxHQUF4QyxFQUE2Q2MsTUFBN0MsQ0FBeEI7QUFDRDtBQUNGLEdBVkg7QUFhQVcsRUFBQUEsS0FBSyxDQUFDUixHQUFOLENBQ0UsdUJBREYsRUFFRVUsR0FBRyxDQUFDLFFBQUQsQ0FGTCxFQUdFLFVBQVU1QixHQUFWLEVBQStCQyxHQUEvQixFQUEyRDtBQUN6RCxRQUFJZ0IsZ0JBQUVDLEdBQUYsQ0FBTUgsTUFBTixFQUFjLGtDQUFkLE1BQXNEaUMsU0FBMUQsRUFBcUU7QUFDbkVwRCxNQUFBQSxjQUFjLENBQUNJLEdBQUcsQ0FBQ2tDLE1BQUosQ0FBV1UsT0FBWixFQUFxQjVDLEdBQUcsQ0FBQ2tDLE1BQUosQ0FBV3BDLFFBQWhDLEVBQTBDQyxPQUExQyxFQUFtREMsR0FBbkQsRUFBd0RDLEdBQXhELENBQWQ7QUFDRCxLQUZELE1BRU87QUFDTGEsTUFBQUEsd0JBQXdCLENBQUNkLEdBQUcsQ0FBQ2tDLE1BQUosQ0FBV1UsT0FBWixFQUFxQjVDLEdBQUcsQ0FBQ2tDLE1BQUosQ0FBV3BDLFFBQWhDLEVBQTBDQyxPQUExQyxFQUFtREMsR0FBbkQsRUFBd0RDLEdBQXhELEVBQTZEYyxNQUE3RCxDQUF4QjtBQUNEO0FBQ0YsR0FUSDtBQVdEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgQ29uZmlnLCBQYWNrYWdlIH0gZnJvbSAnQHZlcmRhY2Npby90eXBlcyc7XG5pbXBvcnQgeyBhbGxvdyB9IGZyb20gJy4uLy4uL21pZGRsZXdhcmUnO1xuaW1wb3J0IHsgY29udmVydERpc3RSZW1vdGVUb0xvY2FsVGFyYmFsbFVybHMsIGdldFZlcnNpb24sIEVycm9yQ29kZSB9IGZyb20gJy4uLy4uLy4uL2xpYi91dGlscyc7XG5pbXBvcnQgeyBIRUFERVJTLCBESVNUX1RBR1MsIEFQSV9FUlJPUiB9IGZyb20gJy4uLy4uLy4uL2xpYi9jb25zdGFudHMnO1xuaW1wb3J0IHtcbiAgSUF1dGgsXG4gICRSZXNwb25zZUV4dGVuZCxcbiAgJFJlcXVlc3RFeHRlbmQsXG4gICROZXh0RnVuY3Rpb25WZXIsXG4gIElTdG9yYWdlSGFuZGxlclxufSBmcm9tICcuLi8uLi8uLi8uLi90eXBlcyc7XG5cbmNvbnN0IGRvd25sb2FkU3RyZWFtID0gKFxuICBwYWNrYWdlTmFtZTogc3RyaW5nLFxuICBmaWxlbmFtZTogc3RyaW5nLFxuICBzdG9yYWdlOiBhbnksXG4gIHJlcTogJFJlcXVlc3RFeHRlbmQsXG4gIHJlczogJFJlc3BvbnNlRXh0ZW5kXG4pOiB2b2lkID0+IHtcbiAgY29uc3Qgc3RyZWFtID0gc3RvcmFnZS5nZXRUYXJiYWxsKHBhY2thZ2VOYW1lLCBmaWxlbmFtZSk7XG5cbiAgc3RyZWFtLm9uKCdjb250ZW50LWxlbmd0aCcsIGZ1bmN0aW9uIChjb250ZW50KTogdm9pZCB7XG4gICAgcmVzLmhlYWRlcignQ29udGVudC1MZW5ndGgnLCBjb250ZW50KTtcbiAgfSk7XG5cbiAgc3RyZWFtLm9uKCdlcnJvcicsIGZ1bmN0aW9uIChlcnIpOiB2b2lkIHtcbiAgICByZXR1cm4gcmVzLmxvY2Fscy5yZXBvcnRfZXJyb3IoZXJyKTtcbiAgfSk7XG5cbiAgcmVzLmhlYWRlcihIRUFERVJTLkNPTlRFTlRfVFlQRSwgSEVBREVSUy5PQ1RFVF9TVFJFQU0pO1xuICBzdHJlYW0ucGlwZShyZXMpO1xufTtcblxuY29uc3QgcmVkaXJlY3RPckRvd25sb2FkU3RyZWFtID0gKFxuICBwYWNrYWdlTmFtZTogc3RyaW5nLFxuICBmaWxlbmFtZTogc3RyaW5nLFxuICBzdG9yYWdlOiBhbnksXG4gIHJlcTogJFJlcXVlc3RFeHRlbmQsXG4gIHJlczogJFJlc3BvbnNlRXh0ZW5kLFxuICBjb25maWc6IENvbmZpZ1xuKTogdm9pZCA9PiB7XG4gIGNvbnN0IHRhcmJhbGxVcmxSZWRpcmVjdCA9IF8uZ2V0KGNvbmZpZywgJ2V4cGVyaW1lbnRzLnRhcmJhbGxfdXJsX3JlZGlyZWN0Jyk7XG4gIHN0b3JhZ2UuaGFzTG9jYWxUYXJiYWxsKHBhY2thZ2VOYW1lLCBmaWxlbmFtZSkudGhlbihoYXNMb2NhbFRhcmJhbGwgPT4ge1xuICAgIGlmIChoYXNMb2NhbFRhcmJhbGwpIHtcbiAgICAgIGNvbnN0IGNvbnRleHQgPSB7IHBhY2thZ2VOYW1lLCBmaWxlbmFtZSB9O1xuICAgICAgY29uc3QgdGFyYmFsbFVybCA9IHR5cGVvZiB0YXJiYWxsVXJsUmVkaXJlY3QgPT09ICdmdW5jdGlvbidcbiAgICAgICAgPyB0YXJiYWxsVXJsUmVkaXJlY3QoY29udGV4dClcbiAgICAgICAgOiBfLnRlbXBsYXRlKHRhcmJhbGxVcmxSZWRpcmVjdCkoY29udGV4dCk7XG4gICAgICByZXMucmVkaXJlY3QodGFyYmFsbFVybCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRvd25sb2FkU3RyZWFtKHBhY2thZ2VOYW1lLCBmaWxlbmFtZSwgc3RvcmFnZSwgcmVxLCByZXMpXG4gICAgfVxuICB9KS5jYXRjaChlcnIgPT4ge1xuICAgIHJlcy5sb2NhbHMucmVwb3J0X2Vycm9yKGVycik7XG4gIH0pO1xufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiAoXG4gIHJvdXRlOiBSb3V0ZXIsXG4gIGF1dGg6IElBdXRoLFxuICBzdG9yYWdlOiBJU3RvcmFnZUhhbmRsZXIsXG4gIGNvbmZpZzogQ29uZmlnXG4pOiB2b2lkIHtcbiAgY29uc3QgY2FuID0gYWxsb3coYXV0aCk7XG4gIC8vIFRPRE86IGFub255bW91cyB1c2VyP1xuICByb3V0ZS5nZXQoXG4gICAgJy86cGFja2FnZS86dmVyc2lvbj8nLFxuICAgIGNhbignYWNjZXNzJyksXG4gICAgZnVuY3Rpb24gKHJlcTogJFJlcXVlc3RFeHRlbmQsIHJlczogJFJlc3BvbnNlRXh0ZW5kLCBuZXh0OiAkTmV4dEZ1bmN0aW9uVmVyKTogdm9pZCB7XG4gICAgICBjb25zdCBnZXRQYWNrYWdlTWV0YUNhbGxiYWNrID0gZnVuY3Rpb24gKGVyciwgbWV0YWRhdGE6IFBhY2thZ2UpOiB2b2lkIHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJldHVybiBuZXh0KGVycik7XG4gICAgICAgIH1cbiAgICAgICAgbWV0YWRhdGEgPSBjb252ZXJ0RGlzdFJlbW90ZVRvTG9jYWxUYXJiYWxsVXJscyhtZXRhZGF0YSwgcmVxLCBjb25maWcudXJsX3ByZWZpeCk7XG5cbiAgICAgICAgbGV0IHF1ZXJ5VmVyc2lvbiA9IHJlcS5wYXJhbXMudmVyc2lvbjtcbiAgICAgICAgaWYgKF8uaXNOaWwocXVlcnlWZXJzaW9uKSkge1xuICAgICAgICAgIHJldHVybiBuZXh0KG1ldGFkYXRhKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB2ZXJzaW9uID0gZ2V0VmVyc2lvbihtZXRhZGF0YSwgcXVlcnlWZXJzaW9uKTtcbiAgICAgICAgaWYgKF8uaXNOaWwodmVyc2lvbikgPT09IGZhbHNlKSB7XG4gICAgICAgICAgcmV0dXJuIG5leHQodmVyc2lvbik7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoXy5pc05pbChtZXRhZGF0YVtESVNUX1RBR1NdKSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICBpZiAoXy5pc05pbChtZXRhZGF0YVtESVNUX1RBR1NdW3F1ZXJ5VmVyc2lvbl0pID09PSBmYWxzZSkge1xuICAgICAgICAgICAgcXVlcnlWZXJzaW9uID0gbWV0YWRhdGFbRElTVF9UQUdTXVtxdWVyeVZlcnNpb25dO1xuICAgICAgICAgICAgdmVyc2lvbiA9IGdldFZlcnNpb24obWV0YWRhdGEsIHF1ZXJ5VmVyc2lvbik7XG4gICAgICAgICAgICBpZiAoXy5pc05pbCh2ZXJzaW9uKSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIG5leHQodmVyc2lvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXh0KEVycm9yQ29kZS5nZXROb3RGb3VuZChgJHtBUElfRVJST1IuVkVSU0lPTl9OT1RfRVhJU1R9OiAke3JlcS5wYXJhbXMudmVyc2lvbn1gKSk7XG4gICAgICB9O1xuXG4gICAgICBzdG9yYWdlLmdldFBhY2thZ2Uoe1xuICAgICAgICBuYW1lOiByZXEucGFyYW1zLnBhY2thZ2UsXG4gICAgICAgIHVwbGlua3NMb29rOiB0cnVlLFxuICAgICAgICByZXEsXG4gICAgICAgIGNhbGxiYWNrOiBnZXRQYWNrYWdlTWV0YUNhbGxiYWNrXG4gICAgICB9KTtcbiAgICB9XG4gICk7XG5cbiAgcm91dGUuZ2V0KFxuICAgICcvOnNjb3BlZFBhY2thZ2UvLS86c2NvcGUvOmZpbGVuYW1lJyxcbiAgICBjYW4oJ2FjY2VzcycpLFxuICAgIGZ1bmN0aW9uIChyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6ICRSZXNwb25zZUV4dGVuZCk6IHZvaWQge1xuICAgICAgY29uc3QgeyBzY29wZWRQYWNrYWdlLCBmaWxlbmFtZSB9ID0gcmVxLnBhcmFtcztcbiAgICAgIGlmIChfLmdldChjb25maWcsICdleHBlcmltZW50cy50YXJiYWxsX3VybF9yZWRpcmVjdCcpID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgZG93bmxvYWRTdHJlYW0oc2NvcGVkUGFja2FnZSwgZmlsZW5hbWUsIHN0b3JhZ2UsIHJlcSwgcmVzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlZGlyZWN0T3JEb3dubG9hZFN0cmVhbShzY29wZWRQYWNrYWdlLCBmaWxlbmFtZSwgc3RvcmFnZSwgcmVxLCByZXMsIGNvbmZpZyk7XG4gICAgICB9XG4gICAgfVxuICApO1xuXG4gIHJvdXRlLmdldChcbiAgICAnLzpwYWNrYWdlLy0vOmZpbGVuYW1lJyxcbiAgICBjYW4oJ2FjY2VzcycpLFxuICAgIGZ1bmN0aW9uIChyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6ICRSZXNwb25zZUV4dGVuZCk6IHZvaWQge1xuICAgICAgaWYgKF8uZ2V0KGNvbmZpZywgJ2V4cGVyaW1lbnRzLnRhcmJhbGxfdXJsX3JlZGlyZWN0JykgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBkb3dubG9hZFN0cmVhbShyZXEucGFyYW1zLnBhY2thZ2UsIHJlcS5wYXJhbXMuZmlsZW5hbWUsIHN0b3JhZ2UsIHJlcSwgcmVzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlZGlyZWN0T3JEb3dubG9hZFN0cmVhbShyZXEucGFyYW1zLnBhY2thZ2UsIHJlcS5wYXJhbXMuZmlsZW5hbWUsIHN0b3JhZ2UsIHJlcSwgcmVzLCBjb25maWcpO1xuICAgICAgfVxuICAgIH1cbiAgKTtcbn1cbiJdfQ==